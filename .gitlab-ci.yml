image: docker:18

services:
  - docker:19.03.0-dind

stages:
  - build
  - push

variables:
  http_proxy: ""
  https_proxy: ""
  no_proxy: ""
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375


before_script:
  - docker ps
 # - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_BUILD_TOKEN
 
Build:
  stage: build
  script:
     - docker ps
     - 'ls -al * '
     - 'pwd'
     - 'echo "registry image : " + $CI_REGISTRY_IMAGE + " ci build token " + $CI_BUILD_TOKEN'
     - docker build -f Dockerfile -t beelogger-admin .
#    - docker pull $CI_REGISTRY_IMAGE:latest || true
#    - >
#      docker build
#      --pull
#      --build-arg http_proxy=$http_proxy
#      --build-arg https_proxy=$https_proxy
#      --build-arg no_proxy=$no_proxy
#      --build-arg VCS_REF=$CI_COMMIT_SHA
#      --build-arg VCS_URL=$CI_PROJECT_URL
#      --cache-from $CI_REGISTRY_IMAGE:latest
#      --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
#      .
#    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA


Push latest:
  variables:
    GIT_STRATEGY: none
  stage: push
  only:
    - master
  script:
     - docker images
 #   - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
 #   - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
 #   - docker push $CI_REGISTRY_IMAGE:latest

Push tag:
  variables:
    GIT_STRATEGY: none
  stage: push
  only:
    - tags
  script:
     - docker images
 #   - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
 #   - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
 #   - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
